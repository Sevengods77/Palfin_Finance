<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palfin Security - Spam Detection AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

    <!-- Header / Nav -->
    <div
        style="position: absolute; top: 0; left: 0; right: 0; padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100;">
        <div style="font-family: 'Quintessential', cursive; font-size: 24px; color: var(--text);">Palfin</div>
        <div>
            <button class="btn btn-secondary" onclick="openModal('loginModal')" id="loginBtn">Login</button>
            <button class="btn btn-primary" onclick="logout()" id="logoutBtn" style="display: none;">Logout</button>
        </div>
    </div>

    <!-- Hero Section (Palfin UI) -->
    <section class="hero-section" id="hero">
        <h1 class="hero-title text-center">
            Master Your Security with <span class="highlight">Palfin</span>
        </h1>
        <p class="hero-subtitle text-center">
            AI-powered threat detection. Track, analyze, and secure your communications with intelligent insights.
        </p>

        <div class="hero-cta">
            <button class="btn btn-primary" onclick="openModal('signupModal')">
                <i class="fas fa-shield-alt"></i> Get Started Free
            </button>
            <button class="btn btn-secondary" onclick="openModal('loginModal')">
                <i class="fas fa-user"></i> Login
            </button>
        </div>

        <div class="scroll-indicator"
            onclick="document.getElementById('features').scrollIntoView({behavior: 'smooth'})">
            Explore Features â†“
        </div>
    </section>

    <!-- Main App Section (Hidden until Login for effect, or shown as demo) -->
    <!-- For this demo, we make it accessible but emphasize the "Dashboard" feel -->

    <!-- Tools Section (Palfin UI) -->
    <section id="features" class="tools-section">
        <div class="container">
            <h2 class="section-title">Tools & Features</h2>
            <p class="section-subtitle">
                Everything you need to take control of your digital safety.
            </p>

            <div class="tools-grid">
                <div class="tool-card">
                    <div class="tool-icon">ðŸ“Š</div>
                    <div class="tool-title">Real-time Analysis</div>
                    <p class="tool-desc">Automatically parse and categorize emails to detect threats instantly.</p>
                </div>
                <div class="tool-card">
                    <div class="tool-icon">ðŸ§ </div>
                    <div class="tool-title">Smart Learning</div>
                    <p class="tool-desc">Federated learning improves accuracy without compromising privacy.</p>
                </div>
                <div class="tool-card">
                    <div class="tool-icon">ðŸ¤–</div>
                    <div class="tool-title">AI Powered</div>
                    <p class="tool-desc">Advanced GRU and Neural Networks identify complex patterns.</p>
                </div>
                <div class="tool-card">
                    <div class="tool-icon">ðŸ”’</div>
                    <div class="tool-title">Private by Design</div>
                    <p class="tool-desc">Your data stays on your device. Only model updates are shared.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Secure Dashboard (Spam App + Stats) -->
    <section id="app" class="app-section">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-shield-virus"></i> Security Dashboard</h1>
                <p style="color: var(--text-secondary)">Live Threat Detection Workspace</p>
            </div>

            <!-- Palfin Behavioral Coach & Stats -->
            <div id="dashboard-stats" style="display: none;">
                <div class="tip-card">
                    <div class="tip-title"><i class="fas fa-lightbulb"></i> Behavioral Coach</div>
                    <div id="dailyTip" style="font-style: italic; color: var(--text);">Loading insight...</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">Current Balance</div>
                        <div class="stat-value" id="stat-balance">--</div>
                        <div class="stat-subtext">Available to spend</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Monthly Spend</div>
                        <div class="stat-value" id="stat-spend" style="color: var(--primary);">--</div>
                        <div class="stat-subtext">â–¼ 12% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Savings Rate</div>
                        <div class="stat-value" id="stat-savings" style="color: var(--accent);">--</div>
                        <div class="stat-subtext">On track for goal</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Streak</div>
                        <div class="stat-value" id="stat-streak" style="color: #F59E0B;">--</div>
                        <div class="stat-subtext">Days Secure</div>
                    </div>
                </div>
            </div>

            <div class="main-container">
                <!-- Input Section -->
                <div class="card-glass">
                    <div class="card-title">
                        <i class="fas fa-robot"></i> AI Analysis
                    </div>
                    <textarea id="emailInput" placeholder="Paste the email content here to analyze..."></textarea>
                    <button onclick="detectSpam()" id="predictBtn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-bolt"></i> Analyze Email
                    </button>

                    <div id="result">
                        <div class="prediction-text" id="predictionText"></div>
                        <div id="confidenceText" style="font-weight: 600; opacity: 0.8;"></div>
                        <div class="confidence-bar-bg">
                            <div class="confidence-bar-fill" id="confidenceBar"></div>
                        </div>
                    </div>
                </div>

                <!-- Live Charts Section -->
                <div class="charts-container">
                    <div class="card-glass">
                        <div class="card-title">
                            <i class="fas fa-chart-pie"></i> Training Distribution
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="dataChart"></canvas>
                        </div>
                    </div>

                    <div class="card-glass">
                        <div class="card-title">
                            <i class="fas fa-chart-line"></i> Live Session Metrics
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="historyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Finize Chat Widget -->
    <div class="chat-widget-btn" onclick="toggleChat()">
        <i class="fas fa-robot"></i>
    </div>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-robot" style="color: var(--primary);"></i> Finize Assistant
            </div>
            <div onclick="toggleChat()" style="cursor: pointer; padding: 5px;">âœ•</div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message msg-bot">
                Hi! I'm Finize, your financial & security assistant. How can I help you today?
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask Finize..."
                onkeypress="handleChatKey(event)">
            <button class="chat-send" onclick="sendChatMessage()">â†’</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal">
            <h2 class="text-center" style="margin-bottom: 20px; color: var(--primary);">Login</h2>
            <input type="email" placeholder="Email" class="chat-input"
                style="width: 100%; margin-bottom: 10px; box-sizing: border-box;">
            <input type="password" placeholder="Password" class="chat-input"
                style="width: 100%; margin-bottom: 20px; box-sizing: border-box;">
            <button class="btn btn-primary" style="width: 100%;" onclick="simulateLogin()">Login</button>
            <p class="text-center" style="margin-top: 10px; cursor: pointer; color: var(--text-secondary);"
                onclick="closeModal('loginModal')">Cancel</p>
        </div>
    </div>

    <div id="signupModal" class="modal-overlay">
        <div class="modal">
            <h2 class="text-center" style="margin-bottom: 20px; color: var(--primary);">Sign Up</h2>
            <input type="text" placeholder="Full Name" class="chat-input"
                style="width: 100%; margin-bottom: 10px; box-sizing: border-box;">
            <input type="email" placeholder="Email" class="chat-input"
                style="width: 100%; margin-bottom: 10px; box-sizing: border-box;">
            <input type="password" placeholder="Password" class="chat-input"
                style="width: 100%; margin-bottom: 20px; box-sizing: border-box;">
            <button class="btn btn-primary" style="width: 100%;" onclick="simulateLogin()">Create Account</button>
            <p class="text-center" style="margin-top: 10px; cursor: pointer; color: var(--text-secondary);"
                onclick="closeModal('signupModal')">Cancel</p>
        </div>
    </div>

    <script>
        // --- Chat Widget Logic ---
        function toggleChat() {
            const chat = document.getElementById('chatWindow');
            if (chat.style.display === 'flex') {
                chat.style.display = 'none';
            } else {
                chat.style.display = 'flex';
                document.getElementById('chatInput').focus();
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            // Add User Message
            const msgs = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'message msg-user';
            userMsg.textContent = text;
            msgs.appendChild(userMsg);
            msgs.scrollTop = msgs.scrollHeight;
            input.value = '';

            // Loading state
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'message msg-bot';
            loadingMsg.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            msgs.appendChild(loadingMsg);
            msgs.scrollTop = msgs.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await response.json();

                // Replace loading with bot reply
                msgs.removeChild(loadingMsg);
                const botMsg = document.createElement('div');
                botMsg.className = 'message msg-bot';
                botMsg.textContent = data.reply;
                msgs.appendChild(botMsg);
                msgs.scrollTop = msgs.scrollHeight;

            } catch (e) {
                console.error(e);
                msgs.removeChild(loadingMsg);
            }
        }

        // --- Auth & Dashboard Logic ---
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function simulateLogin() {
            closeModal('loginModal');
            closeModal('signupModal');

            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('hero').style.display = 'none'; // Optional: hide hero to focus on dash
            document.getElementById('dashboard-stats').style.display = 'block';

            // Load Dashboard Data
            try {
                const res = await fetch('/api/dashboard-data');
                const data = await res.json();

                document.getElementById('stat-balance').innerText = 'â‚¹' + data.balance.toLocaleString();
                document.getElementById('stat-spend').innerText = 'â‚¹' + data.monthlyExpenses.toLocaleString();
                document.getElementById('stat-savings').innerText = data.savingsRate + '%';
                document.getElementById('stat-streak').innerText = data.streak + ' Days';
                document.getElementById('dailyTip').innerText = `"${data.dailyTip}"`;

            } catch (e) { console.error("Failed to load dash data", e); }

            // Scroll to app
            document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
        }

        function logout() {
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('hero').style.display = 'flex';
            document.getElementById('dashboard-stats').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        // --- Existing Spam Logic (Preserved) ---
        let dataChart, historyChart;
        const sessionHistory = { labels: [], data: [] };

        Chart.defaults.font.family = "'Outfit', sans-serif";
        Chart.defaults.color = '#94A3B8';
        Chart.defaults.borderColor = '#1E293B';

        async function initCharts() {
            try {
                const response = await fetch('/stats');
                const stats = await response.json();
                const ctxData = document.getElementById('dataChart').getContext('2d');
                dataChart = new Chart(ctxData, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stats),
                        datasets: [{
                            data: Object.values(stats),
                            backgroundColor: ['#22C55E', '#EF4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, color: '#F8FAFC' } } }
                    }
                });
            } catch (e) { }

            const ctxHistory = document.getElementById('historyChart').getContext('2d');
            const gradient = ctxHistory.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(34, 197, 94, 0.5)');
            gradient.addColorStop(1, 'rgba(34, 197, 94, 0.0)');

            historyChart = new Chart(ctxHistory, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Spam Probability',
                        data: [],
                        borderColor: '#22C55E',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: gradient,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#22C55E',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 1, grid: { color: '#1E293B' }, ticks: { color: '#94A3B8' } },
                        x: { grid: { display: false }, ticks: { color: '#94A3B8' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function detectSpam() {
            const email = document.getElementById('emailInput').value;
            const resultDiv = document.getElementById('result');
            const btn = document.getElementById('predictBtn');
            const originalBtnText = btn.innerHTML;

            if (!email.trim()) { alert("Please enter some text."); return; }
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Analyzing...';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                const data = await response.json();
                if (response.ok) {
                    resultDiv.style.display = 'block';
                    const isSpam = data.prediction === 'Phishing detected';
                    resultDiv.className = isSpam ? 'result-spam' : 'result-ham';
                    document.getElementById('predictionText').innerHTML =
                        `<i class="fas ${isSpam ? 'fa-radiation' : 'fa-check-circle'}"></i> ${data.prediction}`;
                    const confidenceVal = parseFloat(data.confidence.replace('%', ''));
                    document.getElementById('confidenceText').innerText = `Confidence Score: ${data.confidence}`;
                    document.getElementById('confidenceBar').style.width = `${confidenceVal}%`;
                    document.getElementById('confidenceBar').style.backgroundColor = isSpam ? '#EF4444' : '#22C55E';

                    const timeLabel = new Date().toLocaleTimeString();
                    sessionHistory.labels.push(timeLabel);
                    sessionHistory.data.push(data.score);
                    if (sessionHistory.labels.length > 10) { sessionHistory.labels.shift(); sessionHistory.data.shift(); }
                    historyChart.data.labels = sessionHistory.labels;
                    historyChart.data.datasets[0].data = sessionHistory.data;
                    historyChart.update();
                } else { alert("Error: " + data.error); }
            } catch (error) { console.error(error); alert("An error occurred."); } finally { btn.disabled = false; btn.innerHTML = originalBtnText; }
        }

        initCharts();
    </script>
</body>

</html>