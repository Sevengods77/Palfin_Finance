<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palfin Security - {% block title %}Home{% endblock %}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block head %}{% endblock %}
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-logo">
                <i class="fas fa-shield-halved"
                    style="color: var(--primary); margin-right: 10px; font-size: 1.2em;"></i> Palfin
            </a>
            <div class="nav-links">
                <a href="/#features" class="nav-link">Features</a>
                {% if request.endpoint == 'dashboard' %}
                <a href="/logout" class="btn btn-primary btn-sm">Logout</a>
                {% else %}
                <a href="/login" class="btn btn-secondary btn-sm">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Finize Chat Widget (Available on all pages) -->
    <div class="chat-widget-btn" onclick="toggleChat()">
        <i class="fas fa-robot"></i>
    </div>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-robot" style="color: var(--primary);"></i> Finize Assistant
            </div>
            <div onclick="toggleChat()" style="cursor: pointer; padding: 5px;">✕</div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message msg-bot">
                Hi! I'm Finize, your financial & security assistant. How can I help you today?
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask Finize..."
                onkeypress="handleChatKey(event)">
            <button class="chat-send" onclick="sendChatMessage()">→</button>
        </div>
    </div>

    <script>
        // Chat Logic
        function toggleChat() {
            const chat = document.getElementById('chatWindow');
            if (chat.style.display === 'flex') {
                chat.style.display = 'none';
            } else {
                chat.style.display = 'flex';
                document.getElementById('chatInput').focus();
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            const msgs = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'message msg-user';
            userMsg.textContent = text;
            msgs.appendChild(userMsg);
            msgs.scrollTop = msgs.scrollHeight;
            input.value = '';

            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'message msg-bot';
            loadingMsg.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            msgs.appendChild(loadingMsg);
            msgs.scrollTop = msgs.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await response.json();

                msgs.removeChild(loadingMsg);
                const botMsg = document.createElement('div');
                botMsg.className = 'message msg-bot';
                botMsg.textContent = data.reply;
                msgs.appendChild(botMsg);
                msgs.scrollTop = msgs.scrollHeight;

            } catch (e) {
                console.error(e);
                msgs.removeChild(loadingMsg);
            }
        }
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>